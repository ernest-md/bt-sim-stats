<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Visor Excels</title>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    .bar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    button { padding: 8px 10px; cursor: pointer; }
    select { padding: 8px 10px; }
    .hint { color:#666; margin-top: 10px; font-size: 13px; }

    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; vertical-align: middle; }
    tr:nth-child(even) td { background: #f7f7f7; }
    thead th { position: sticky; top: 0; background: #fff; z-index: 1; }

    .imgcell img { display:block; max-height: 70px; max-width: 90px; object-fit: contain; }
    th { font-weight: 700; background:#f2f2f2; }
  .wr-ok { background:#A6FFB3 !important; color:#00690D; font-weight:600; }
  .wr-bad { background:#fee2e2 !important; color:#991b1b; font-weight:600; }

    .box-win { border: 2px solid #8bcf95; }
  .box-lose { border: 2px solid #f1a3a3; }

  .head-win { background:#dff1df !important; font-weight:700; }
  .head-lose { background:#f6d2d2 !important; font-weight:700; }

  .t-win { color:#2e7d32; font-weight:700; }
  .t-lose { color:#c62828; font-weight:700; }
  </style>
</head>
<body>

  <div class="bar">
    <button onclick="loadExcel('COQUITO.xlsx')">COQUITO</button>
    <button onclick="loadExcel('ESTEREO.xlsx')">ESTEREO</button>
    <button onclick="loadExcel('OSHIN.xlsx')">OSHIN</button>

    <span style="margin-left:10px;">Hoja:</span>
    <select id="sheets" onchange="renderSheet()" disabled></select>
  </div>

  <div class="hint" id="status">Selecciona un Excel.</div>
  <div id="output"></div>

  <script>
    let workbook = null;

    async function loadExcel(file) {
  document.getElementById('status').textContent = `Cargando ${file}...`;
  document.getElementById('output').innerHTML = '';
  workbook = null;

  const res = await fetch(file, { cache: "no-store" });
  if (!res.ok) {
    document.getElementById('status').textContent = `No se pudo cargar ${file}`;
    return;
  }

  const data = await res.arrayBuffer();
  workbook = XLSX.read(data, { cellFormula: true });

  const select = document.getElementById('sheets');
  select.innerHTML = "";

  workbook.SheetNames.forEach((name) => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
  });

  // ✅ Seleccionar "RESUMEN" por defecto (case-insensitive)
  const target = workbook.SheetNames.find(n => n.toLowerCase() === "resumen");
  select.value = target ?? workbook.SheetNames[0];

  select.disabled = false;
  document.getElementById('status').textContent = `${file} cargado.`;
  renderSheet();
}

    function renderSheet() {
  if (!workbook) return;

  const sheetName = document.getElementById('sheets').value;
  const sheet = workbook.Sheets[sheetName];
  const range = XLSX.utils.decode_range(sheet['!ref'] || "A1:A1");

  // Helpers
  const getCellText = (r, c) => {
    const addr = XLSX.utils.encode_cell({ r, c });
    const cell = sheet[addr];
    if (!cell) return "";
    if (cell.w != null) return String(cell.w);
    if (cell.v != null) return String(cell.v);
    return "";
  };

  const findCell = (predicate) => {
    for (let r = range.s.r; r <= range.e.r; r++) {
      for (let c = range.s.c; c <= range.e.c; c++) {
        const t = getCellText(r, c).trim();
        if (t && predicate(t)) return { r, c, t };
      }
    }
    return null;
  };

  const blockEndRow = (anchor) => {
    if (!anchor) return null;
    const c0 = anchor.c;
    const c1 = anchor.c + 1;
    for (let r = anchor.r + 1; r <= range.e.r; r++) {
      const a = getCellText(r, c0).trim();
      const b = getCellText(r, c1).trim();
      if (!a && !b) return r - 1;
    }
    return range.e.r;
  };

  // Detecta bloques por texto
  const winAnchor = findCell(t => t.toLowerCase() === "más victorias contra");
  const loseAnchor = findCell(t => t.toLowerCase() === "más derrotas contra");
  const winEnd = winAnchor ? blockEndRow(winAnchor) : null;
  const loseEnd = loseAnchor ? blockEndRow(loseAnchor) : null;

  // Cabeceras (fila 0)
  const headers = [];
  for (let C = range.s.c; C <= range.e.c; C++) {
    const a = XLSX.utils.encode_cell({ r: range.s.r, c: C });
    headers.push(sheet[a]?.w ?? sheet[a]?.v ?? "");
  }

  const html = ['<table><thead><tr>'];
  headers.forEach(h => html.push(`<th>${escapeHtml(h)}</th>`));
  html.push('</tr></thead><tbody>');

  for (let R = range.s.r + 1; R <= range.e.r; R++) {
    html.push('<tr>');
    for (let C = range.s.c; C <= range.e.c; C++) {
      const addr = XLSX.utils.encode_cell({ r: R, c: C });
      const cell = sheet[addr];

      // OJO: fórmula solo nos interesa para IMAGE; si no, mejor w/v
      const formula = cell?.f ? ("=" + String(cell.f)) : "";
      let v = "";
      if (cell) {
        if (cell.w != null) v = String(cell.w);
        else if (cell.v != null) v = String(cell.v);
      }

      // IMG: prioriza fórmula IMAGE si existe
      const imgUrl = extractImageUrl(formula || v);
      if (imgUrl) {
        // clases del bloque (si la celda cae dentro)
        let cls = "imgcell";
        if (winAnchor && R >= winAnchor.r && R <= winEnd && C >= winAnchor.c && C <= winAnchor.c + 1) cls += " box-win";
        if (loseAnchor && R >= loseAnchor.r && R <= loseEnd && C >= loseAnchor.c && C <= loseAnchor.c + 1) cls += " box-lose";

        // cabecera del bloque
        if (winAnchor && R === winAnchor.r && C >= winAnchor.c && C <= winAnchor.c + 1) cls += " head-win";
        if (loseAnchor && R === loseAnchor.r && C >= loseAnchor.c && C <= loseAnchor.c + 1) cls += " head-lose";

        html.push(`<td class="${cls}"><img src="${escapeAttr(imgUrl)}"></td>`);
        continue;
      }

      // --- clases extra (bloques expansión) ---
      let extraClass = "";

      // Bloque victorias
      if (winAnchor && R >= winAnchor.r && R <= winEnd && C >= winAnchor.c && C <= winAnchor.c + 1) {
        extraClass += " box-win";
        if (R === winAnchor.r) extraClass += " head-win";
      }

      // Bloque derrotas
      if (loseAnchor && R >= loseAnchor.r && R <= loseEnd && C >= loseAnchor.c && C <= loseAnchor.c + 1) {
        extraClass += " box-lose";
        if (R === loseAnchor.r) extraClass += " head-lose";
      }

      // Contenido con coloreado de labels
      let cellHtml = escapeHtml(v);
      cellHtml = cellHtml
        .replace(/VICTORIAS:/g, '<span class="t-win">VICTORIAS:</span>')
        .replace(/DERROTAS:/g, '<span class="t-lose">DERROTAS:</span>');

      // --- WR ---
      const header = String(headers[C - range.s.c] ?? "").trim().toUpperCase();
      const isWR = header === "WR";
      const pm = String(v).match(/(-?\d+(?:[.,]\d+)?)\s*%/);

      if (isWR && pm) {
        const n = parseFloat(pm[1].replace(',', '.'));
        const cls = (n >= 50 ? 'wr-ok' : 'wr-bad') + (extraClass ? (" " + extraClass.trim()) : "");
        html.push(`<td class="${cls}">${cellHtml}</td>`);
      } else {
        html.push(`<td class="${extraClass.trim()}">${cellHtml}</td>`);
      }
    }
    html.push('</tr>');
  }

  html.push('</tbody></table>');
  document.getElementById('output').innerHTML = html.join('');
}

    // Soporta =IMAGE("url";...) o =IMAGE("url",...) y también sin comillas (raro)
    function extractImageUrl(s) {
      if (typeof s !== "string") return null;
      const t = s.trim();

      // Caso típico: =IMAGE("https://...";4;80;60) o comas
      let m = t.match(/^=IMAGE\(\s*"([^"]+)"\s*[,;)]/i);
      if (m) return m[1];

      // Variante: =IMAGE(https://...;...)
      m = t.match(/^=IMAGE\(\s*(https?:\/\/[^,;\)]+)\s*[,;)]/i);
      if (m) return m[1];

      return null;
    }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    function escapeAttr(s){
      return String(s).replace(/"/g, "&quot;");
    }
  </script>
</body>
</html>
